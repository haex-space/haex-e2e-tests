# Kong configuration for Sync Server Supabase Stack
# Routes auth requests to GoTrue
# Uses supabase-demo JWT keys (same as haex-sync-server development setup)

_format_version: "2.1"
_transform: true

###
### Consumers / API Keys
###
consumers:
  - username: anon
    keyauth_credentials:
      # supabase-demo anon key
      - key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
    acls:
      - group: anon
  - username: service_role
    keyauth_credentials:
      # supabase-demo service_role key
      - key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
    acls:
      - group: admin

###
### API Routes
###
services:
  ## ==========================================================================
  ## AUTH (GoTrue)
  ## ==========================================================================
  - name: auth-v1-verify
    url: http://sync-gotrue:9999/verify
    routes:
      - name: auth-v1-verify
        strip_path: true
        paths:
          - /auth/v1/verify
    plugins:
      - name: cors

  - name: auth-v1-all
    url: http://sync-gotrue:9999
    routes:
      - name: auth-v1-all
        strip_path: true
        paths:
          - /auth/v1/
    plugins:
      - name: cors

  ## ==========================================================================
  ## SYNC SERVER API
  ## Proxy all /auth/login and /sync/* routes to the sync-server
  ## ==========================================================================
  - name: sync-server-auth
    url: http://sync-server:3002
    routes:
      - name: sync-server-auth
        strip_path: false
        paths:
          - /auth/login
          - /auth/signup
    plugins:
      - name: cors

  - name: sync-server-api
    url: http://sync-server:3002
    routes:
      - name: sync-server-api
        strip_path: false
        paths:
          - /sync
          - /vault
          - /vaults
    plugins:
      - name: cors

  ## ==========================================================================
  ## Health check
  ## ==========================================================================
  - name: health
    url: http://sync-gotrue:9999/health
    routes:
      - name: health
        paths:
          - /health
