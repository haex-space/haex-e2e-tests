# Kong configuration for Sync Server Supabase Stack
# Routes auth requests to GoTrue

_format_version: "2.1"
_transform: true

###
### Consumers / API Keys
###
consumers:
  - username: anon
    keyauth_credentials:
      # JWT: {"iss":"supabase","ref":"e2e-sync","role":"anon","iat":1768029459,"exp":2083389459}
      # Secret: super-secret-sync-jwt-token-with-at-least-32-characters
      - key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImUyZS1zeW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMjk0NTksImV4cCI6MjA4MzM4OTQ1OX0.iLIimpCYBntebpU45lvZBF2_CY0Tf31v1eBFNe3IOSw
    acls:
      - group: anon
  - username: service_role
    keyauth_credentials:
      # JWT: {"iss":"supabase","ref":"e2e-sync","role":"service_role","iat":1768029459,"exp":2083389459}
      - key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImUyZS1zeW5jIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODAyOTQ1OSwiZXhwIjoyMDgzMzg5NDU5fQ.d27yJx2pIbqRwFrI3WFm2G0XD4zEpDxSbEtVOlrg93Q
    acls:
      - group: admin

###
### API Routes
###
services:
  ## ==========================================================================
  ## AUTH (GoTrue)
  ## ==========================================================================
  - name: auth-v1-verify
    url: http://sync-gotrue:9999/verify
    routes:
      - name: auth-v1-verify
        strip_path: true
        paths:
          - /auth/v1/verify
    plugins:
      - name: cors

  - name: auth-v1-all
    url: http://sync-gotrue:9999
    routes:
      - name: auth-v1-all
        strip_path: true
        paths:
          - /auth/v1/
    plugins:
      - name: cors

  ## ==========================================================================
  ## Health check
  ## ==========================================================================
  - name: health
    url: http://sync-gotrue:9999/health
    routes:
      - name: health
        paths:
          - /health
