# haex-e2e-tests Docker Compose Configuration
#
# Usage:
#   docker compose -f docker/docker-compose.yml build
#   docker compose -f docker/docker-compose.yml up -d
#   docker compose -f docker/docker-compose.yml run --rm e2e-test-env pnpm test
#
# Version configuration via environment variables:
#   HAEX_VAULT_VERSION=v1.0.0 docker compose build
#   VERSION_PRESET=release docker compose build
#
# Pre-built artifact mode:
#   USE_PREBUILT_VAULT=true docker compose build
#   (requires binary in docker/prebuilt/haex-vault/haex-space)
#
#   SYNC_SERVER_IMAGE=ghcr.io/haex-space/haex-sync-server:latest docker compose up
#   (uses pre-built sync-server image instead of building)

services:
  # PostgreSQL Database with Supabase extensions
  db:
    image: supabase/postgres:15.8.1.085
    container_name: haex_e2e_db
    restart: unless-stopped
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
      - -c
      - log_min_messages=fatal
    environment:
      POSTGRES_HOST: /var/run/postgresql
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      POSTGRES_PORT: 5432
      # Supabase-specific passwords for auth and other services
      SUPABASE_AUTH_ADMIN_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - db_data:/var/lib/postgresql/data:Z
      # Post-init script to set passwords for auth and storage roles
      - ./init/postgresql.schema.sql:/etc/postgresql.schema.sql:ro
    healthcheck:
      test: pg_isready -U postgres -h localhost
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - e2e-network

  # GoTrue Auth Service (Supabase Auth)
  gotrue:
    image: supabase/gotrue:v2.169.0
    container_name: haex_e2e_gotrue
    restart: unless-stopped
    environment:
      # Database - use supabase_auth_admin which is created by the postgres image
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgresql://supabase_auth_admin:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-postgres}?sslmode=disable
      # API Settings
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: http://auth:80
      # JWT Settings
      GOTRUE_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
      GOTRUE_JWT_EXP: 3600
      GOTRUE_JWT_AUD: authenticated
      # Site URL
      GOTRUE_SITE_URL: http://localhost:3000
      # Disable email verification for testing
      GOTRUE_MAILER_AUTOCONFIRM: "true"
      GOTRUE_SMS_AUTOCONFIRM: "true"
      # Disable external providers
      GOTRUE_EXTERNAL_EMAIL_ENABLED: "true"
      GOTRUE_EXTERNAL_PHONE_ENABLED: "false"
      # Logging
      GOTRUE_LOG_LEVEL: warn
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9999/health"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 3
    networks:
      - e2e-network

  # Kong API Gateway - provides Supabase-compatible API
  kong:
    image: kong:2.8.1
    container_name: haex_e2e_kong
    restart: unless-stopped
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /home/kong/kong.yml
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_PLUGINS: request-transformer,cors,key-auth,acl,basic-auth,request-termination
      KONG_NGINX_PROXY_PROXY_BUFFER_SIZE: 160k
      KONG_NGINX_PROXY_PROXY_BUFFERS: 64 160k
    volumes:
      - ./kong/kong.yml:/home/kong/kong.yml:ro
    # Ports only exposed within e2e-network, no public ports needed
    depends_on:
      gotrue:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      start_period: 10s
      retries: 3
    networks:
      - e2e-network

  # haex-sync-server for sync tests
  # Can use pre-built image (SYNC_SERVER_IMAGE) or build from GitHub (HAEX_SYNC_SERVER_VERSION)
  sync-server:
    image: ${SYNC_SERVER_IMAGE:-}
    build:
      context: .
      dockerfile: Dockerfile.sync-server
      args:
        - HAEX_SYNC_SERVER_REF=${HAEX_SYNC_SERVER_VERSION:-main}
    container_name: haex_e2e_sync
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-postgres}
      # Point to Kong API Gateway (Supabase-compatible)
      SUPABASE_URL: http://kong:8000
      # JWT keys - these are signed with the same secret as GoTrue's JWT_SECRET
      # Secret: super-secret-jwt-token-with-at-least-32-characters-long
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImUyZS10ZXN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMjk0NTksImV4cCI6MjA4MzM4OTQ1OX0.QOZn8PwKUlOOebj3itD6b6jyDkV_D89VCCxDNxxeXXI}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImUyZS10ZXN0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODAyOTQ1OSwiZXhwIjoyMDgzMzg5NDU5fQ.UcDi2zTazpFGGXl8TGCQJiwpoG-lqHpTOYqNfidvHaM}
      PORT: 3002
      NODE_ENV: test
      CORS_ORIGIN: "*"
    # Ports only exposed within e2e-network, no public ports needed
    depends_on:
      db:
        condition: service_healthy
      kong:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "bun", "-e", "fetch('http://localhost:3002/').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 3
    networks:
      - e2e-network

  # E2E Test Environment - Vault A (Primary, with Playwright)
  vault-a:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        - HAEX_VAULT_REF=${HAEX_VAULT_VERSION:-main}
        - HAEXTENSION_REF=${HAEXTENSION_VERSION:-main}
        - VAULT_SDK_REF=${VAULT_SDK_VERSION:-main}
        - USE_PREBUILT_VAULT=${USE_PREBUILT_VAULT:-false}
    container_name: haex_e2e_vault_a
    # webtop requires s6-overlay to run as PID 1, so we can't use init: true
    tty: true
    stdin_open: true
    security_opt:
      - seccomp:unconfined
    cap_add:
      - NET_ADMIN  # Required for iptables to redirect traffic to localhost
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Berlin}
      # Sync server URL for tests
      - SYNC_SERVER_URL=http://sync-server:3002
      # Supabase keys for admin user creation
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImUyZS10ZXN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMjk0NTksImV4cCI6MjA4MzM4OTQ1OX0.QOZn8PwKUlOOebj3itD6b6jyDkV_D89VCCxDNxxeXXI}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImUyZS10ZXN0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODAyOTQ1OSwiZXhwIjoyMDgzMzg5NDU5fQ.UcDi2zTazpFGGXl8TGCQJiwpoG-lqHpTOYqNfidvHaM}
      # Database URL for direct verification
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-postgres}
      # CI mode detection
      - CI=${CI:-false}
      # Instance identifier
      - VAULT_INSTANCE=A
    volumes:
      # Named volume for test results (no permission issues)
      - test-results:/app/test-results
    # No public ports needed - all services communicate within e2e-network
    shm_size: "2gb"
    depends_on:
      db:
        condition: service_healthy
      sync-server:
        condition: service_healthy
    networks:
      - e2e-network

  # E2E Test Environment - Vault B (Secondary)
  vault-b:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        - HAEX_VAULT_REF=${HAEX_VAULT_VERSION:-main}
        - HAEXTENSION_REF=${HAEXTENSION_VERSION:-main}
        - VAULT_SDK_REF=${VAULT_SDK_VERSION:-main}
        - USE_PREBUILT_VAULT=${USE_PREBUILT_VAULT:-false}
    container_name: haex_e2e_vault_b
    tty: true
    stdin_open: true
    security_opt:
      - seccomp:unconfined
    cap_add:
      - NET_ADMIN  # Required for iptables to redirect traffic to localhost
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Europe/Berlin}
      # Sync server URL for tests
      - SYNC_SERVER_URL=http://sync-server:3002
      # Supabase keys for admin user creation
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImUyZS10ZXN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwMjk0NTksImV4cCI6MjA4MzM4OTQ1OX0.QOZn8PwKUlOOebj3itD6b6jyDkV_D89VCCxDNxxeXXI}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImUyZS10ZXN0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODAyOTQ1OSwiZXhwIjoyMDgzMzg5NDU5fQ.UcDi2zTazpFGGXl8TGCQJiwpoG-lqHpTOYqNfidvHaM}
      # Database URL for direct verification
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-postgres}
      # CI mode detection
      - CI=${CI:-false}
      # Instance identifier
      - VAULT_INSTANCE=B
    # No public ports needed - all services communicate within e2e-network
    shm_size: "2gb"
    depends_on:
      db:
        condition: service_healthy
      sync-server:
        condition: service_healthy
    networks:
      - e2e-network

networks:
  e2e-network:
    driver: bridge

volumes:
  test-results:
  db_data:
