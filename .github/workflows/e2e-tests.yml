name: E2E Tests

on:
  # Callable from other repositories (haex-vault, haextension, etc.)
  workflow_call:
    inputs:
      build_type:
        description: 'Build type: build (PR/push), nightly, or release'
        type: string
        required: true
      # Option 1: Load versions from project config (.e2e-versions.json)
      source_project:
        description: 'Load versions from this project config (haex-vault, haextension, vault-sdk, haex-sync-server)'
        type: string
        default: ''
      source_ref:
        description: 'Git ref to load config from (only used with source_project)'
        type: string
        default: 'main'
      version_profile:
        description: 'Version profile to use from config (only used with source_project)'
        type: string
        default: ''
      # Option 2: Specify versions directly (ignored if source_project is set)
      haex_vault_version:
        description: 'haex-vault version (branch, tag, or commit)'
        type: string
        default: 'main'
      haextension_version:
        description: 'haextension version (branch, tag, or commit)'
        type: string
        default: 'main'
      vault_sdk_version:
        description: 'vault-sdk version (branch, tag, or commit)'
        type: string
        default: 'main'
      sync_server_version:
        description: 'haex-sync-server version (branch, tag, or commit)'
        type: string
        default: 'main'
      # Option 3: Use pre-built artifacts (skips building that component)
      haex_vault_artifact:
        description: 'GitHub artifact name containing pre-built haex-vault (skips vault build if set)'
        type: string
        default: ''
      haex_vault_artifact_run_id:
        description: 'Run ID to download haex-vault artifact from (required if haex_vault_artifact is set)'
        type: string
        default: ''
      sync_server_image:
        description: 'Pre-built sync-server Docker image (e.g., ghcr.io/haex-space/haex-sync-server:latest)'
        type: string
        default: ''
      haex_vault_android_artifact:
        description: 'GitHub artifact name containing pre-built Android APK (enables Android E2E tests if set)'
        type: string
        default: ''
    secrets:
      ARTIFACT_TOKEN:
        description: 'Token with permission to download artifacts from other repos (defaults to GITHUB_TOKEN)'
        required: false
    outputs:
      success:
        description: 'Whether all tests passed (desktop and android if enabled)'
        value: ${{ jobs.e2e.outputs.success && (inputs.haex_vault_android_artifact == '' || jobs.android-e2e.outputs.success) }}
      test_result:
        description: 'Desktop test result summary'
        value: ${{ jobs.e2e.outputs.test_result }}
      android_test_result:
        description: 'Android test result summary'
        value: ${{ jobs.android-e2e.outputs.test_result }}
      artifact_name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.e2e.outputs.artifact_name }}
      run_id:
        description: 'GitHub Actions run ID'
        value: ${{ jobs.e2e.outputs.run_id }}

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        type: choice
        options:
          - build
          - nightly
          - release
        default: build
      # Option 1: Load versions from project config
      source_project:
        description: 'Load versions from project config (leave empty to use manual versions)'
        type: choice
        options:
          - ''
          - haex-vault
          - haextension
          - vault-sdk
          - haex-sync-server
        default: ''
      source_ref:
        description: 'Git ref to load config from'
        default: 'main'
      version_profile:
        description: 'Version profile (leave empty for default)'
        default: ''
      # Option 2: Specify versions directly
      haex_vault_version:
        description: 'haex-vault version (ignored if source_project is set)'
        default: 'main'
      haextension_version:
        description: 'haextension version (ignored if source_project is set)'
        default: 'main'
      vault_sdk_version:
        description: 'vault-sdk version (ignored if source_project is set)'
        default: 'main'
      sync_server_version:
        description: 'haex-sync-server version (ignored if source_project is set)'
        default: 'main'

jobs:
  e2e:
    name: E2E Tests (${{ inputs.build_type }})
    runs-on: ubuntu-latest
    timeout-minutes: 90
    # All build types are blocking - E2E test failures fail the pipeline

    outputs:
      success: ${{ steps.test.outcome == 'success' }}
      test_result: ${{ steps.test.outcome }}
      artifact_name: e2e-artifacts-${{ inputs.build_type }}-${{ github.run_id }}
      run_id: ${{ github.run_id }}

    steps:
      - name: Checkout E2E tests
        uses: actions/checkout@v4
        with:
          repository: haex-space/haex-e2e-tests
          ref: main

      - name: Download haex-vault artifact (if provided)
        if: inputs.haex_vault_artifact != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.haex_vault_artifact }}
          run-id: ${{ inputs.haex_vault_artifact_run_id }}
          github-token: ${{ secrets.ARTIFACT_TOKEN || github.token }}
          path: ./docker/prebuilt/haex-vault

      - name: Prepare pre-built artifacts
        id: prebuilt
        run: |
          USE_PREBUILT_VAULT="false"
          USE_PREBUILT_SYNC_SERVER="false"

          # Check if haex-vault artifact was downloaded
          if [ -d "./docker/prebuilt/haex-vault" ]; then
            echo "Found pre-built haex-vault artifact"
            ls -la ./docker/prebuilt/haex-vault/
            USE_PREBUILT_VAULT="true"

            # Make binary executable
            if [ -f "./docker/prebuilt/haex-vault/haex-space" ]; then
              chmod +x ./docker/prebuilt/haex-vault/haex-space
            fi
          fi

          # Check if sync-server image is specified
          if [ -n "${{ inputs.sync_server_image }}" ]; then
            echo "Using pre-built sync-server image: ${{ inputs.sync_server_image }}"
            USE_PREBUILT_SYNC_SERVER="true"
          fi

          echo "use_prebuilt_vault=$USE_PREBUILT_VAULT" >> $GITHUB_OUTPUT
          echo "use_prebuilt_sync_server=$USE_PREBUILT_SYNC_SERVER" >> $GITHUB_OUTPUT

      - name: Resolve versions from project config
        id: versions
        run: |
          SOURCE_PROJECT="${{ inputs.source_project }}"

          if [ -n "$SOURCE_PROJECT" ]; then
            echo "Loading versions from $SOURCE_PROJECT config..."

            # Install jq for JSON parsing
            sudo apt-get update -qq && sudo apt-get install -y -qq jq

            # Source the script to get versions
            source scripts/fetch-project-versions.sh \
              "$SOURCE_PROJECT" \
              "${{ inputs.source_ref }}" \
              "${{ inputs.version_profile }}"

            # Export to GitHub outputs
            echo "haex_vault_version=$HAEX_VAULT_VERSION" >> $GITHUB_OUTPUT
            echo "haextension_version=$HAEXTENSION_VERSION" >> $GITHUB_OUTPUT
            echo "vault_sdk_version=$VAULT_SDK_VERSION" >> $GITHUB_OUTPUT
            echo "sync_server_version=$HAEX_SYNC_SERVER_VERSION" >> $GITHUB_OUTPUT
            echo "source=config" >> $GITHUB_OUTPUT
          else
            echo "Using manually specified versions..."

            # Use input values directly
            echo "haex_vault_version=${{ inputs.haex_vault_version }}" >> $GITHUB_OUTPUT
            echo "haextension_version=${{ inputs.haextension_version }}" >> $GITHUB_OUTPUT
            echo "vault_sdk_version=${{ inputs.vault_sdk_version }}" >> $GITHUB_OUTPUT
            echo "sync_server_version=${{ inputs.sync_server_version }}" >> $GITHUB_OUTPUT
            echo "source=manual" >> $GITHUB_OUTPUT
          fi

      - name: Log test configuration
        run: |
          echo "## E2E Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | \`${{ inputs.build_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Source | \`${{ steps.versions.outputs.source }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.versions.outputs.source }}" == "config" ]; then
            echo "| Source Project | \`${{ inputs.source_project }}@${{ inputs.source_ref }}\` |" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ inputs.version_profile }}" ]; then
              echo "| Profile | \`${{ inputs.version_profile }}\` |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Show haex-vault source
          if [ "${{ steps.prebuilt.outputs.use_prebuilt_vault }}" == "true" ]; then
            echo "| haex-vault | \`PRE-BUILT ARTIFACT\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| haex-vault | \`${{ steps.versions.outputs.haex_vault_version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| haextension | \`${{ steps.versions.outputs.haextension_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| vault-sdk | \`${{ steps.versions.outputs.vault_sdk_version }}\` |" >> $GITHUB_STEP_SUMMARY

          # Show sync-server source
          if [ "${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}" == "true" ]; then
            echo "| sync-server | \`${{ inputs.sync_server_image }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| sync-server | \`${{ steps.versions.outputs.sync_server_version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.build_type }}" == "nightly" ]; then
            echo "> **Note:** Nightly build - test failures will not block the pipeline" >> $GITHUB_STEP_SUMMARY
          else
            echo "> **Note:** Release build - test failures will block the pipeline" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test environment
        env:
          HAEX_VAULT_VERSION: ${{ steps.versions.outputs.haex_vault_version }}
          HAEXTENSION_VERSION: ${{ steps.versions.outputs.haextension_version }}
          VAULT_SDK_VERSION: ${{ steps.versions.outputs.vault_sdk_version }}
          HAEX_SYNC_SERVER_VERSION: ${{ steps.versions.outputs.sync_server_version }}
          USE_PREBUILT_VAULT: ${{ steps.prebuilt.outputs.use_prebuilt_vault }}
          USE_PREBUILT_SYNC_SERVER: ${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}
          SYNC_SERVER_IMAGE: ${{ inputs.sync_server_image }}
        run: |
          echo "Building with:"
          if [ "$USE_PREBUILT_VAULT" == "true" ]; then
            echo "  haex-vault: PRE-BUILT"
          else
            echo "  haex-vault: $HAEX_VAULT_VERSION"
          fi
          echo "  haextension: $HAEXTENSION_VERSION"
          echo "  vault-sdk: $VAULT_SDK_VERSION"
          if [ "$USE_PREBUILT_SYNC_SERVER" == "true" ]; then
            echo "  sync-server: $SYNC_SERVER_IMAGE"
          else
            echo "  sync-server: $HAEX_SYNC_SERVER_VERSION"
          fi

          # Ensure prebuilt directory exists (even if empty)
          # The Dockerfile's build context is the repo root (..), so prebuilt/ must be there
          mkdir -p prebuilt

          docker compose -f docker/docker-compose.yml build

      - name: Start services
        env:
          HAEX_VAULT_VERSION: ${{ steps.versions.outputs.haex_vault_version }}
          HAEXTENSION_VERSION: ${{ steps.versions.outputs.haextension_version }}
          VAULT_SDK_VERSION: ${{ steps.versions.outputs.vault_sdk_version }}
          HAEX_SYNC_SERVER_VERSION: ${{ steps.versions.outputs.sync_server_version }}
          USE_PREBUILT_VAULT: ${{ steps.prebuilt.outputs.use_prebuilt_vault }}
          USE_PREBUILT_SYNC_SERVER: ${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}
          SYNC_SERVER_IMAGE: ${{ inputs.sync_server_image }}
        run: |
          docker compose -f docker/docker-compose.yml up -d db sync-server

          # Wait for services to be healthy
          echo "Waiting for services to be ready..."
          sleep 10
          docker compose -f docker/docker-compose.yml ps

      - name: Run E2E tests
        id: test
        env:
          HAEX_VAULT_VERSION: ${{ steps.versions.outputs.haex_vault_version }}
          HAEXTENSION_VERSION: ${{ steps.versions.outputs.haextension_version }}
          VAULT_SDK_VERSION: ${{ steps.versions.outputs.vault_sdk_version }}
          HAEX_SYNC_SERVER_VERSION: ${{ steps.versions.outputs.sync_server_version }}
          USE_PREBUILT_VAULT: ${{ steps.prebuilt.outputs.use_prebuilt_vault }}
          USE_PREBUILT_SYNC_SERVER: ${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}
          SYNC_SERVER_IMAGE: ${{ inputs.sync_server_image }}
          CI: true
        run: |
          # Run tests in vault-a container which has Playwright installed
          docker compose -f docker/docker-compose.yml run --rm vault-a pnpm test

      - name: Copy test results from container
        if: always()
        run: |
          mkdir -p ./test-results

          # Copy from named volume via temporary container
          # Volume name is docker_test-results (docker/ directory prefix)
          docker run --rm \
            -v docker_test-results:/results \
            -v $(pwd)/test-results:/output \
            alpine sh -c "cp -r /results/* /output/ 2>/dev/null || true"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-${{ inputs.build_type }}-${{ github.run_id }}
          path: |
            test-results/artifacts/
            test-results/html-report/
            test-results/results.json
          retention-days: 90

      - name: Write test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Result" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test.outcome }}" == "success" ]; then
            echo "✅ **Tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Tests failed**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Stop services
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down -v

  # Android E2E Tests - runs after desktop tests, uses Maestro for UI automation
  android-e2e:
    name: Android E2E Tests (${{ inputs.build_type }})
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: e2e
    # Only run if Android artifact is provided
    if: inputs.haex_vault_android_artifact != ''

    outputs:
      success: ${{ steps.test.outcome == 'success' }}
      test_result: ${{ steps.test.outcome }}

    steps:
      - name: Checkout E2E tests
        uses: actions/checkout@v4
        with:
          repository: haex-space/haex-e2e-tests
          ref: main

      - name: Enable KVM for Android emulator
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Download Android APK artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.haex_vault_android_artifact }}
          run-id: ${{ inputs.haex_vault_artifact_run_id }}
          github-token: ${{ secrets.ARTIFACT_TOKEN || github.token }}
          path: ./apk

      - name: List APK files
        run: |
          echo "Downloaded APK files:"
          ls -la ./apk/
          find ./apk -name "*.apk" -type f

      - name: Install Maestro
        run: |
          curl -Ls https://get.maestro.mobile.dev | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          df -h

      - name: Start backend services for sync tests
        run: |
          # Start only the services needed for Android sync tests
          docker compose -f docker/docker-compose.yml up -d db gotrue kong sync-server

          # Wait for services to be healthy
          echo "Waiting for backend services..."
          for i in {1..60}; do
            if curl -s http://localhost:3002/ > /dev/null 2>&1; then
              echo "Sync server is ready!"
              break
            fi
            echo "Waiting for sync server... ($i/60)"
            sleep 2
          done

          # Verify all services are up
          docker compose -f docker/docker-compose.yml ps

      - name: Create test script
        run: |
          cat > /tmp/android-e2e-test.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          WORKSPACE="$1"
          echo "Working directory: $(pwd)"
          echo "WORKSPACE: $WORKSPACE"
          ls -la "$WORKSPACE/apk/"
          APK_FILE=$(find "$WORKSPACE/apk" -name "*.apk" -type f 2>/dev/null | head -1)
          echo "Found APK file: $APK_FILE"
          if [ -z "$APK_FILE" ]; then
            echo "ERROR: No APK file found!"
            exit 1
          fi
          adb install "$APK_FILE"
          adb reverse tcp:3002 tcp:3002
          adb reverse tcp:8000 tcp:8000
          echo "Running Maestro smoke test..."
          ~/.maestro/bin/maestro test "$WORKSPACE/.maestro/android-smoke-test.yaml" --format junit --output "$WORKSPACE/maestro-results.xml" || true
          if [ -f "$WORKSPACE/.maestro/android-sync-test.yaml" ]; then
            ~/.maestro/bin/maestro test "$WORKSPACE/.maestro/android-sync-test.yaml" --format junit --output "$WORKSPACE/maestro-sync-results.xml" || true
          fi
          SCRIPT
          chmod +x /tmp/android-e2e-test.sh

      - name: Run Android E2E Tests
        id: test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          working-directory: ${{ github.workspace }}
          script: /tmp/android-e2e-test.sh ${{ github.workspace }}

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-results-${{ inputs.build_type }}-${{ github.run_id }}
          path: |
            maestro-results.xml
            maestro-sync-results.xml
            ~/.maestro/tests/
          retention-days: 30

      - name: Write Android test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Android E2E Test Result" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test.outcome }}" == "success" ]; then
            echo "✅ **Android tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Android tests failed**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Stop backend services
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down -v
