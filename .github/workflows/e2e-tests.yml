name: E2E Tests

on:
  # Callable from other repositories (haex-vault, haextension, etc.)
  workflow_call:
    inputs:
      build_type:
        description: 'Build type: nightly or release'
        type: string
        required: true
      # Option 1: Load versions from project config (.e2e-versions.json)
      source_project:
        description: 'Load versions from this project config (haex-vault, haextension, vault-sdk, haex-sync-server)'
        type: string
        default: ''
      source_ref:
        description: 'Git ref to load config from (only used with source_project)'
        type: string
        default: 'main'
      version_profile:
        description: 'Version profile to use from config (only used with source_project)'
        type: string
        default: ''
      # Option 2: Specify versions directly (ignored if source_project is set)
      haex_vault_version:
        description: 'haex-vault version (branch, tag, or commit)'
        type: string
        default: 'main'
      haextension_version:
        description: 'haextension version (branch, tag, or commit)'
        type: string
        default: 'main'
      vault_sdk_version:
        description: 'vault-sdk version (branch, tag, or commit)'
        type: string
        default: 'main'
      sync_server_version:
        description: 'haex-sync-server version (branch, tag, or commit)'
        type: string
        default: 'main'
      # Option 3: Use pre-built artifacts (skips building that component)
      haex_vault_artifact:
        description: 'GitHub artifact name containing pre-built haex-vault (skips vault build if set)'
        type: string
        default: ''
      haex_vault_artifact_run_id:
        description: 'Run ID to download haex-vault artifact from (required if haex_vault_artifact is set)'
        type: string
        default: ''
      sync_server_image:
        description: 'Pre-built sync-server Docker image (e.g., ghcr.io/haex-space/haex-sync-server:latest)'
        type: string
        default: ''
    secrets:
      ARTIFACT_TOKEN:
        description: 'Token with permission to download artifacts from other repos (defaults to GITHUB_TOKEN)'
        required: false
    outputs:
      success:
        description: 'Whether tests passed'
        value: ${{ jobs.e2e.outputs.success }}
      test_result:
        description: 'Test result summary'
        value: ${{ jobs.e2e.outputs.test_result }}
      artifact_name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.e2e.outputs.artifact_name }}
      run_id:
        description: 'GitHub Actions run ID'
        value: ${{ jobs.e2e.outputs.run_id }}

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        type: choice
        options:
          - nightly
          - release
        default: nightly
      # Option 1: Load versions from project config
      source_project:
        description: 'Load versions from project config (leave empty to use manual versions)'
        type: choice
        options:
          - ''
          - haex-vault
          - haextension
          - vault-sdk
          - haex-sync-server
        default: ''
      source_ref:
        description: 'Git ref to load config from'
        default: 'main'
      version_profile:
        description: 'Version profile (leave empty for default)'
        default: ''
      # Option 2: Specify versions directly
      haex_vault_version:
        description: 'haex-vault version (ignored if source_project is set)'
        default: 'main'
      haextension_version:
        description: 'haextension version (ignored if source_project is set)'
        default: 'main'
      vault_sdk_version:
        description: 'vault-sdk version (ignored if source_project is set)'
        default: 'main'
      sync_server_version:
        description: 'haex-sync-server version (ignored if source_project is set)'
        default: 'main'

jobs:
  e2e:
    name: E2E Tests (${{ inputs.build_type }})
    runs-on: ubuntu-latest
    timeout-minutes: 90
    # For nightly: continue even if tests fail
    # For release: fail the workflow if tests fail
    continue-on-error: ${{ inputs.build_type == 'nightly' }}

    outputs:
      success: ${{ steps.test.outcome == 'success' }}
      test_result: ${{ steps.test.outcome }}
      artifact_name: e2e-artifacts-${{ inputs.build_type }}-${{ github.run_id }}
      run_id: ${{ github.run_id }}

    steps:
      - name: Checkout E2E tests
        uses: actions/checkout@v4
        with:
          repository: haex-space/haex-e2e-tests
          ref: main

      - name: Download haex-vault artifact (if provided)
        if: inputs.haex_vault_artifact != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.haex_vault_artifact }}
          run-id: ${{ inputs.haex_vault_artifact_run_id }}
          github-token: ${{ secrets.ARTIFACT_TOKEN || github.token }}
          path: ./docker/prebuilt/haex-vault

      - name: Prepare pre-built artifacts
        id: prebuilt
        run: |
          USE_PREBUILT_VAULT="false"
          USE_PREBUILT_SYNC_SERVER="false"

          # Check if haex-vault artifact was downloaded
          if [ -d "./docker/prebuilt/haex-vault" ]; then
            echo "Found pre-built haex-vault artifact"
            ls -la ./docker/prebuilt/haex-vault/
            USE_PREBUILT_VAULT="true"

            # Make binary executable
            if [ -f "./docker/prebuilt/haex-vault/haex-space" ]; then
              chmod +x ./docker/prebuilt/haex-vault/haex-space
            fi
          fi

          # Check if sync-server image is specified
          if [ -n "${{ inputs.sync_server_image }}" ]; then
            echo "Using pre-built sync-server image: ${{ inputs.sync_server_image }}"
            USE_PREBUILT_SYNC_SERVER="true"
          fi

          echo "use_prebuilt_vault=$USE_PREBUILT_VAULT" >> $GITHUB_OUTPUT
          echo "use_prebuilt_sync_server=$USE_PREBUILT_SYNC_SERVER" >> $GITHUB_OUTPUT

      - name: Resolve versions from project config
        id: versions
        run: |
          SOURCE_PROJECT="${{ inputs.source_project }}"

          if [ -n "$SOURCE_PROJECT" ]; then
            echo "Loading versions from $SOURCE_PROJECT config..."

            # Install jq for JSON parsing
            sudo apt-get update -qq && sudo apt-get install -y -qq jq

            # Source the script to get versions
            source scripts/fetch-project-versions.sh \
              "$SOURCE_PROJECT" \
              "${{ inputs.source_ref }}" \
              "${{ inputs.version_profile }}"

            # Export to GitHub outputs
            echo "haex_vault_version=$HAEX_VAULT_VERSION" >> $GITHUB_OUTPUT
            echo "haextension_version=$HAEXTENSION_VERSION" >> $GITHUB_OUTPUT
            echo "vault_sdk_version=$VAULT_SDK_VERSION" >> $GITHUB_OUTPUT
            echo "sync_server_version=$HAEX_SYNC_SERVER_VERSION" >> $GITHUB_OUTPUT
            echo "source=config" >> $GITHUB_OUTPUT
          else
            echo "Using manually specified versions..."

            # Use input values directly
            echo "haex_vault_version=${{ inputs.haex_vault_version }}" >> $GITHUB_OUTPUT
            echo "haextension_version=${{ inputs.haextension_version }}" >> $GITHUB_OUTPUT
            echo "vault_sdk_version=${{ inputs.vault_sdk_version }}" >> $GITHUB_OUTPUT
            echo "sync_server_version=${{ inputs.sync_server_version }}" >> $GITHUB_OUTPUT
            echo "source=manual" >> $GITHUB_OUTPUT
          fi

      - name: Log test configuration
        run: |
          echo "## E2E Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | \`${{ inputs.build_type }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Source | \`${{ steps.versions.outputs.source }}\` |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.versions.outputs.source }}" == "config" ]; then
            echo "| Source Project | \`${{ inputs.source_project }}@${{ inputs.source_ref }}\` |" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ inputs.version_profile }}" ]; then
              echo "| Profile | \`${{ inputs.version_profile }}\` |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Show haex-vault source
          if [ "${{ steps.prebuilt.outputs.use_prebuilt_vault }}" == "true" ]; then
            echo "| haex-vault | \`PRE-BUILT ARTIFACT\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| haex-vault | \`${{ steps.versions.outputs.haex_vault_version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| haextension | \`${{ steps.versions.outputs.haextension_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| vault-sdk | \`${{ steps.versions.outputs.vault_sdk_version }}\` |" >> $GITHUB_STEP_SUMMARY

          # Show sync-server source
          if [ "${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}" == "true" ]; then
            echo "| sync-server | \`${{ inputs.sync_server_image }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| sync-server | \`${{ steps.versions.outputs.sync_server_version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.build_type }}" == "nightly" ]; then
            echo "> **Note:** Nightly build - test failures will not block the pipeline" >> $GITHUB_STEP_SUMMARY
          else
            echo "> **Note:** Release build - test failures will block the pipeline" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test environment
        env:
          HAEX_VAULT_VERSION: ${{ steps.versions.outputs.haex_vault_version }}
          HAEXTENSION_VERSION: ${{ steps.versions.outputs.haextension_version }}
          VAULT_SDK_VERSION: ${{ steps.versions.outputs.vault_sdk_version }}
          HAEX_SYNC_SERVER_VERSION: ${{ steps.versions.outputs.sync_server_version }}
          USE_PREBUILT_VAULT: ${{ steps.prebuilt.outputs.use_prebuilt_vault }}
          USE_PREBUILT_SYNC_SERVER: ${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}
          SYNC_SERVER_IMAGE: ${{ inputs.sync_server_image }}
        run: |
          echo "Building with:"
          echo "  haex-vault: ${USE_PREBUILT_VAULT == 'true' && 'PRE-BUILT' || $HAEX_VAULT_VERSION}"
          echo "  haextension: $HAEXTENSION_VERSION"
          echo "  vault-sdk: $VAULT_SDK_VERSION"
          echo "  sync-server: ${USE_PREBUILT_SYNC_SERVER == 'true' && $SYNC_SERVER_IMAGE || $HAEX_SYNC_SERVER_VERSION}"

          docker compose -f docker/docker-compose.yml build

      - name: Start services
        env:
          HAEX_VAULT_VERSION: ${{ steps.versions.outputs.haex_vault_version }}
          HAEXTENSION_VERSION: ${{ steps.versions.outputs.haextension_version }}
          VAULT_SDK_VERSION: ${{ steps.versions.outputs.vault_sdk_version }}
          HAEX_SYNC_SERVER_VERSION: ${{ steps.versions.outputs.sync_server_version }}
          USE_PREBUILT_VAULT: ${{ steps.prebuilt.outputs.use_prebuilt_vault }}
          USE_PREBUILT_SYNC_SERVER: ${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}
          SYNC_SERVER_IMAGE: ${{ inputs.sync_server_image }}
        run: |
          docker compose -f docker/docker-compose.yml up -d db sync-server

          # Wait for services to be healthy
          echo "Waiting for services to be ready..."
          sleep 10
          docker compose -f docker/docker-compose.yml ps

      - name: Run E2E tests
        id: test
        env:
          HAEX_VAULT_VERSION: ${{ steps.versions.outputs.haex_vault_version }}
          HAEXTENSION_VERSION: ${{ steps.versions.outputs.haextension_version }}
          VAULT_SDK_VERSION: ${{ steps.versions.outputs.vault_sdk_version }}
          HAEX_SYNC_SERVER_VERSION: ${{ steps.versions.outputs.sync_server_version }}
          USE_PREBUILT_VAULT: ${{ steps.prebuilt.outputs.use_prebuilt_vault }}
          USE_PREBUILT_SYNC_SERVER: ${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}
          SYNC_SERVER_IMAGE: ${{ inputs.sync_server_image }}
          CI: true
        run: |
          # Run tests in vault-a container which has Playwright installed
          docker compose -f docker/docker-compose.yml run --rm vault-a pnpm test

      - name: Copy test results from container
        if: always()
        run: |
          mkdir -p ./test-results

          # Copy from named volume via temporary container
          # Volume name is docker_test-results (docker/ directory prefix)
          docker run --rm \
            -v docker_test-results:/results \
            -v $(pwd)/test-results:/output \
            alpine sh -c "cp -r /results/* /output/ 2>/dev/null || true"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-${{ inputs.build_type }}-${{ github.run_id }}
          path: |
            test-results/artifacts/
            test-results/html-report/
            test-results/results.json
          retention-days: 90

      - name: Write test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Result" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test.outcome }}" == "success" ]; then
            echo "✅ **Tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Tests failed**" >> $GITHUB_STEP_SUMMARY
            if [ "${{ inputs.build_type }}" == "nightly" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "_Pipeline continues because this is a nightly build_" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Stop services
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down -v
