name: E2E Tests

on:
  # Callable from other repositories (haex-vault, haextension, etc.)
  workflow_call:
    inputs:
      build_type:
        description: 'Build type: build (PR/push), nightly, or release'
        type: string
        required: true
      # Version specification (branch, tag, or commit SHA)
      haex_vault_version:
        description: 'haex-vault version (branch, tag, or commit SHA)'
        type: string
        default: 'main'
      haextension_version:
        description: 'haextension version (branch, tag, or commit SHA)'
        type: string
        default: 'main'
      vault_sdk_version:
        description: 'vault-sdk version (branch, tag, or commit SHA)'
        type: string
        default: 'main'
      sync_server_version:
        description: 'haex-sync-server version (branch, tag, or commit SHA)'
        type: string
        default: 'main'
      # Pre-built artifacts (override version if set)
      haex_vault_artifact:
        description: 'GitHub artifact name containing pre-built haex-vault binary'
        type: string
        default: ''
      haex_vault_artifact_run_id:
        description: 'Run ID to download haex-vault artifact from'
        type: string
        default: ''
      sync_server_image:
        description: 'Pre-built sync-server Docker image (e.g., ghcr.io/haex-space/haex-sync-server:latest)'
        type: string
        default: ''
      haex_vault_android_artifact:
        description: 'GitHub artifact name containing pre-built Android APK (enables Android tests)'
        type: string
        default: ''
    secrets:
      ARTIFACT_TOKEN:
        description: 'Token with permission to download artifacts from other repos'
        required: false
    outputs:
      success:
        description: 'Whether all tests passed'
        value: ${{ jobs.e2e-results.outputs.success && (inputs.haex_vault_android_artifact == '' || jobs.android-e2e.outputs.success) }}
      test_result:
        description: 'Desktop test result summary'
        value: ${{ jobs.e2e-results.outputs.test_result }}
      android_test_result:
        description: 'Android test result summary'
        value: ${{ jobs.android-e2e.outputs.test_result }}
      artifact_name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.e2e-results.outputs.artifact_name }}
      run_id:
        description: 'GitHub Actions run ID'
        value: ${{ jobs.e2e-results.outputs.run_id }}

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        type: choice
        options:
          - build
          - nightly
          - release
        default: build
      haex_vault_version:
        description: 'haex-vault version (branch, tag, or commit SHA)'
        default: 'main'
      haextension_version:
        description: 'haextension version (branch, tag, or commit SHA)'
        default: 'main'
      vault_sdk_version:
        description: 'vault-sdk version (branch, tag, or commit SHA)'
        default: 'main'
      sync_server_version:
        description: 'haex-sync-server version (branch, tag, or commit SHA)'
        default: 'main'

jobs:
  # Build Docker image and save it for parallel test jobs
  build-env:
    name: Build Test Environment
    runs-on: ubuntu-latest
    timeout-minutes: 45

    outputs:
      image_artifact: e2e-docker-image-${{ github.run_id }}
      use_prebuilt_vault: ${{ steps.prebuilt.outputs.use_prebuilt_vault }}
      haex_vault_version: ${{ steps.versions.outputs.haex_vault_version }}
      haextension_version: ${{ steps.versions.outputs.haextension_version }}
      vault_sdk_version: ${{ steps.versions.outputs.vault_sdk_version }}
      sync_server_version: ${{ steps.versions.outputs.sync_server_version }}

    steps:
      - name: Checkout E2E tests
        uses: actions/checkout@v4
        with:
          repository: haex-space/haex-e2e-tests
          ref: main

      - name: Clone dependency repositories
        run: |
          mkdir -p repos

          # Clone haex-sync-server
          echo "Cloning haex-sync-server (${{ inputs.sync_server_version || 'main' }})..."
          git clone --depth 1 --branch ${{ inputs.sync_server_version || 'main' }} \
            https://github.com/haex-space/haex-sync-server.git repos/haex-sync-server || \
          git clone --depth 1 https://github.com/haex-space/haex-sync-server.git repos/haex-sync-server

          # Clone haex-marketplace
          echo "Cloning haex-marketplace (main)..."
          git clone --depth 1 https://github.com/haex-space/haex-marketplace.git repos/haex-marketplace

      - name: Download haex-vault artifact (if provided via workflow_call)
        if: inputs.haex_vault_artifact != '' && inputs.haex_vault_artifact_run_id != ''
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.haex_vault_artifact }}
          run-id: ${{ inputs.haex_vault_artifact_run_id }}
          github-token: ${{ secrets.ARTIFACT_TOKEN || github.token }}
          path: ./docker/prebuilt/haex-vault

      - name: Download latest haex-vault binary (for standalone runs)
        if: inputs.haex_vault_artifact == '' || inputs.haex_vault_artifact_run_id == ''
        env:
          GH_TOKEN: ${{ secrets.ARTIFACT_TOKEN || github.token }}
        run: |
          echo "Fetching latest successful haex-vault build artifact..."

          # Find the latest successful workflow run with the artifact
          RUN_ID=$(gh api repos/haex-space/haex-vault/actions/workflows/build.yml/runs \
            --jq '.workflow_runs | map(select(.conclusion == "success" and .head_branch == "main")) | .[0].id' \
            2>/dev/null || echo "")

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
            echo "No successful build found, will build from source"
            exit 0
          fi

          echo "Found successful run: $RUN_ID"

          # Download the artifact
          mkdir -p ./docker/prebuilt/haex-vault
          cd ./docker/prebuilt/haex-vault

          if gh run download "$RUN_ID" --repo haex-space/haex-vault --name haex-vault-linux-e2e 2>/dev/null; then
            echo "Successfully downloaded pre-built haex-vault binary"
            ls -la
            chmod +x haex-space 2>/dev/null || true
          else
            echo "Could not download artifact, will build from source"
            rm -rf ./docker/prebuilt/haex-vault
          fi

      - name: Prepare pre-built artifacts
        id: prebuilt
        run: |
          USE_PREBUILT_VAULT="false"
          USE_PREBUILT_SYNC_SERVER="false"

          # Check if haex-vault artifact was downloaded
          if [ -d "./docker/prebuilt/haex-vault" ]; then
            echo "Found pre-built haex-vault artifact"
            ls -la ./docker/prebuilt/haex-vault/
            USE_PREBUILT_VAULT="true"

            # Make binary executable
            if [ -f "./docker/prebuilt/haex-vault/haex-space" ]; then
              chmod +x ./docker/prebuilt/haex-vault/haex-space
            fi
          fi

          # Check if sync-server image is specified
          if [ -n "${{ inputs.sync_server_image }}" ]; then
            echo "Using pre-built sync-server image: ${{ inputs.sync_server_image }}"
            USE_PREBUILT_SYNC_SERVER="true"
          fi

          echo "use_prebuilt_vault=$USE_PREBUILT_VAULT" >> $GITHUB_OUTPUT
          echo "use_prebuilt_sync_server=$USE_PREBUILT_SYNC_SERVER" >> $GITHUB_OUTPUT

      - name: Set versions
        id: versions
        run: |
          echo "haex_vault_version=${{ inputs.haex_vault_version }}" >> $GITHUB_OUTPUT
          echo "haextension_version=${{ inputs.haextension_version }}" >> $GITHUB_OUTPUT
          echo "vault_sdk_version=${{ inputs.vault_sdk_version }}" >> $GITHUB_OUTPUT
          echo "sync_server_version=${{ inputs.sync_server_version }}" >> $GITHUB_OUTPUT

      - name: Log test configuration
        run: |
          echo "## E2E Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY

          # Show haex-vault source
          if [ "${{ steps.prebuilt.outputs.use_prebuilt_vault }}" == "true" ]; then
            echo "| haex-vault | \`PRE-BUILT ARTIFACT\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| haex-vault | \`${{ steps.versions.outputs.haex_vault_version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| haextension | \`${{ steps.versions.outputs.haextension_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| vault-sdk | \`${{ steps.versions.outputs.vault_sdk_version }}\` |" >> $GITHUB_STEP_SUMMARY

          # Show sync-server source
          if [ "${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}" == "true" ]; then
            echo "| sync-server | \`${{ inputs.sync_server_image }}\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| sync-server | \`${{ steps.versions.outputs.sync_server_version }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Free disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export Docker images
        env:
          HAEX_VAULT_VERSION: ${{ steps.versions.outputs.haex_vault_version }}
          HAEXTENSION_VERSION: ${{ steps.versions.outputs.haextension_version }}
          VAULT_SDK_VERSION: ${{ steps.versions.outputs.vault_sdk_version }}
          HAEX_SYNC_SERVER_VERSION: ${{ steps.versions.outputs.sync_server_version }}
          USE_PREBUILT_VAULT: ${{ steps.prebuilt.outputs.use_prebuilt_vault }}
          USE_PREBUILT_SYNC_SERVER: ${{ steps.prebuilt.outputs.use_prebuilt_sync_server }}
          SYNC_SERVER_IMAGE: ${{ inputs.sync_server_image }}
          # Paths to cloned repositories
          HAEX_SYNC_SERVER_PATH: ./repos/haex-sync-server
          HAEX_MARKETPLACE_PATH: ./repos/haex-marketplace
          HAEX_VAULT_PATH: .
          HAEX_E2E_TESTS_PATH: ./docker
        run: |
          echo "Building with:"
          if [ "$USE_PREBUILT_VAULT" == "true" ]; then
            echo "  haex-vault: PRE-BUILT"
          else
            echo "  haex-vault: $HAEX_VAULT_VERSION"
          fi
          echo "  haextension: $HAEXTENSION_VERSION"
          echo "  vault-sdk: $VAULT_SDK_VERSION"
          if [ "$USE_PREBUILT_SYNC_SERVER" == "true" ]; then
            echo "  sync-server: $SYNC_SERVER_IMAGE"
          else
            echo "  sync-server: $HAEX_SYNC_SERVER_VERSION (from $HAEX_SYNC_SERVER_PATH)"
          fi
          echo "  marketplace: from $HAEX_MARKETPLACE_PATH"

          # Ensure prebuilt directory exists (even if empty)
          mkdir -p prebuilt

          # Build vault-a, sync-server, and marketplace (vault-b uses same image as vault-a)
          echo "Building Docker images..."
          docker compose -f docker/docker-compose.yml build vault-a sync-server marketplace

          # Export vault, sync-server, and marketplace images for parallel test jobs
          # docker-compose uses project name from directory (docker/)
          echo "Exporting Docker images..."
          echo "Available images:"
          docker images | grep -E "(vault|sync|marketplace)" || true

          # Get actual image names (format: <project>-<service>)
          # vault-a and vault-b use identical Dockerfile/args, so we only save vault-a
          VAULT_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "vault-a" | head -1)
          SYNC_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "sync-server" | head -1)
          MARKETPLACE_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "marketplace" | head -1)

          if [ -z "$VAULT_IMAGE" ] || [ -z "$SYNC_IMAGE" ]; then
            echo "ERROR: Could not find required images"
            docker images
            exit 1
          fi

          echo "Saving images: $VAULT_IMAGE, $SYNC_IMAGE, $MARKETPLACE_IMAGE (vault-b will be tagged from vault-a)"
          if [ -n "$MARKETPLACE_IMAGE" ]; then
            docker save $VAULT_IMAGE $SYNC_IMAGE $MARKETPLACE_IMAGE | gzip > docker-images.tar.gz
          else
            # Marketplace build may have failed or is not available
            echo "Warning: Marketplace image not found, saving without it"
            docker save $VAULT_IMAGE $SYNC_IMAGE | gzip > docker-images.tar.gz
          fi
          ls -lh docker-images.tar.gz

      - name: Upload Docker images artifact
        uses: actions/upload-artifact@v4
        with:
          name: e2e-docker-image-${{ github.run_id }}
          path: docker-images.tar.gz
          retention-days: 1
          compression-level: 0  # Already gzipped

  # Parallel test execution using matrix strategy
  e2e:
    name: E2E Tests - ${{ matrix.shard }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: build-env

    strategy:
      fail-fast: false
      matrix:
        shard:
          - "workflows"    # vault-lifecycle, vault-import, remote-sync
          - "haex-pass"    # get-logins, get-totp, authorization-flow, set-login
          - "other"        # database, ui, limits

    outputs:
      success: ${{ steps.test.outcome == 'success' }}
      test_result: ${{ steps.test.outcome }}
      artifact_name: e2e-artifacts-${{ inputs.build_type }}-${{ github.run_id }}-${{ matrix.shard }}
      run_id: ${{ github.run_id }}

    steps:
      - name: Checkout E2E tests
        uses: actions/checkout@v4
        with:
          repository: haex-space/haex-e2e-tests
          ref: main

      - name: Clone dependency repositories
        run: |
          mkdir -p repos

          # Clone haex-sync-server (needed for kong.yml config)
          echo "Cloning haex-sync-server..."
          git clone --depth 1 https://github.com/haex-space/haex-sync-server.git repos/haex-sync-server

          # Clone haex-marketplace
          echo "Cloning haex-marketplace..."
          git clone --depth 1 https://github.com/haex-space/haex-marketplace.git repos/haex-marketplace

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY" /usr/local/lib/android
          sudo apt-get clean

      - name: Download Docker images
        uses: actions/download-artifact@v4
        with:
          name: e2e-docker-image-${{ github.run_id }}

      - name: Load Docker images
        run: |
          echo "Loading Docker images..."
          gunzip -c docker-images.tar.gz | docker load

          # Tag vault-a as vault-b (they use identical Dockerfile)
          VAULT_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "vault-a" | head -1)
          docker tag "$VAULT_IMAGE" docker-vault-b:latest

          docker images

      - name: Pull base images
        run: |
          # Pull images that weren't exported (base images from registry)
          docker pull supabase/postgres:15.8.1.085
          docker pull supabase/gotrue:v2.169.0
          docker pull kong:2.8.1
          docker pull postgrest/postgrest:v12.2.0
          docker pull supabase/storage-api:v1.14.3

      - name: Start services
        env:
          USE_PREBUILT_VAULT: ${{ needs.build-env.outputs.use_prebuilt_vault }}
          SYNC_SERVER_IMAGE: ${{ inputs.sync_server_image }}
          # Paths to cloned repositories (needed for volume mounts)
          HAEX_SYNC_SERVER_PATH: ./repos/haex-sync-server
          HAEX_MARKETPLACE_PATH: ./repos/haex-marketplace
          HAEX_VAULT_PATH: .
          HAEX_E2E_TESTS_PATH: ./docker
        run: |
          # Start sync stack services (sync-db, sync-gotrue, sync-kong, sync-server)
          docker compose -f docker/docker-compose.yml up -d sync-db sync-gotrue sync-kong sync-server

          # Start marketplace stack services
          docker compose -f docker/docker-compose.yml up -d marketplace-db marketplace-gotrue marketplace-rest marketplace-storage marketplace-kong marketplace

          # Wait for services to be healthy
          echo "Waiting for services to be ready..."
          for i in {1..60}; do
            SYNC_STATUS=$(docker inspect --format='{{.State.Health.Status}}' haex_e2e_sync_server 2>/dev/null || echo "starting")
            MARKETPLACE_STATUS=$(docker inspect --format='{{.State.Health.Status}}' haex_e2e_marketplace 2>/dev/null || echo "starting")
            if [ "$SYNC_STATUS" == "healthy" ] && [ "$MARKETPLACE_STATUS" == "healthy" ]; then
              echo "All services ready after ~$((i*5))s"
              break
            fi
            echo "Waiting for services... ($i/60) - sync-server: $SYNC_STATUS, marketplace: $MARKETPLACE_STATUS"
            sleep 5
          done

          docker compose -f docker/docker-compose.yml ps

      - name: Run E2E tests (${{ matrix.shard }})
        id: test
        env:
          USE_PREBUILT_VAULT: ${{ needs.build-env.outputs.use_prebuilt_vault }}
          CI: true
          # Paths to cloned repositories
          HAEX_SYNC_SERVER_PATH: ./repos/haex-sync-server
          HAEX_MARKETPLACE_PATH: ./repos/haex-marketplace
          HAEX_VAULT_PATH: .
          HAEX_E2E_TESTS_PATH: ./docker
        run: |
          # Start vault containers
          docker compose -f docker/docker-compose.yml up -d vault-a vault-b

          # Wait for tauri-driver to be ready
          echo "Waiting for tauri-driver to be ready..."
          for i in {1..30}; do
            if docker compose -f docker/docker-compose.yml exec -T vault-a curl -s http://localhost:4444/status > /dev/null 2>&1; then
              echo "tauri-driver ready after ~$((i*2))s"
              break
            fi
            echo "Waiting for tauri-driver... ($i/30)"
            sleep 2
          done

          # Determine test directory based on shard
          case "${{ matrix.shard }}" in
            "workflows")
              TEST_DIR="tests/workflows"
              ;;
            "haex-pass")
              TEST_DIR="tests/haex-pass"
              ;;
            "other")
              TEST_DIR="tests/database tests/ui tests/limits"
              ;;
          esac

          echo "Running tests in: $TEST_DIR"
          docker compose -f docker/docker-compose.yml exec vault-a pnpm test $TEST_DIR

      - name: Copy test results from container
        if: always()
        run: |
          mkdir -p ./test-results
          docker run --rm \
            -v docker_test-results:/results \
            -v $(pwd)/test-results:/output \
            alpine sh -c "cp -r /results/* /output/ 2>&1 || echo 'Copy completed (may be empty)'"

      - name: Copy screenshots from container
        if: always()
        run: |
          mkdir -p ./test-results/screenshots
          # Copy screenshots from vault-a container
          docker cp haex_e2e_vault_a:/tmp/. ./test-results/screenshots/ 2>/dev/null || true
          # Filter only screenshot files
          find ./test-results/screenshots -type f ! -name "e2e-screenshot-*.png" -delete 2>/dev/null || true
          echo "Screenshots collected:"
          ls -la ./test-results/screenshots/ 2>/dev/null || echo "No screenshots found"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-artifacts-${{ inputs.build_type }}-${{ github.run_id }}-${{ matrix.shard }}
          path: |
            test-results/artifacts/
            test-results/html-report/
            test-results/results.json
            test-results/screenshots/
          retention-days: 90

      - name: Stop services
        if: always()
        run: |
          docker compose -f docker/docker-compose.yml down -v

  # Aggregate results from parallel test jobs
  e2e-results:
    name: E2E Test Results
    runs-on: ubuntu-latest
    needs: e2e
    if: always()

    outputs:
      success: ${{ steps.check.outputs.success }}
      test_result: ${{ steps.check.outputs.result }}
      artifact_name: e2e-artifacts-${{ inputs.build_type }}-${{ github.run_id }}
      run_id: ${{ github.run_id }}

    steps:
      - name: Check test results
        id: check
        run: |
          # Check if all matrix jobs succeeded
          if [ "${{ needs.e2e.result }}" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "result=success" >> $GITHUB_OUTPUT
            echo "✅ All E2E tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "❌ Some E2E tests failed" >> $GITHUB_STEP_SUMMARY
          fi

  # Android E2E Tests - runs after desktop tests, uses Maestro for UI automation
  android-e2e:
    name: Android E2E Tests (${{ inputs.build_type }})
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: e2e-results
    # Only run if Android artifact is provided
    if: inputs.haex_vault_android_artifact != ''

    outputs:
      success: ${{ steps.test.outcome == 'success' }}
      test_result: ${{ steps.test.outcome }}

    steps:
      - name: Checkout E2E tests
        uses: actions/checkout@v4
        with:
          repository: haex-space/haex-e2e-tests
          ref: main

      - name: Enable KVM for Android emulator
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Download Android APK artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.haex_vault_android_artifact }}
          run-id: ${{ inputs.haex_vault_artifact_run_id }}
          github-token: ${{ secrets.ARTIFACT_TOKEN || github.token }}
          path: ./apk

      - name: List APK files
        run: |
          echo "Downloaded APK files:"
          ls -la ./apk/
          find ./apk -name "*.apk" -type f

      - name: Install Maestro
        run: |
          curl -Ls https://get.maestro.mobile.dev | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          df -h

      - name: Clone dependency repositories
        run: |
          mkdir -p repos
          echo "Cloning haex-sync-server..."
          git clone --depth 1 https://github.com/haex-space/haex-sync-server.git repos/haex-sync-server

      - name: Start backend services for sync tests
        env:
          HAEX_SYNC_SERVER_PATH: ./repos/haex-sync-server
        run: |
          # Start sync stack services needed for Android sync tests
          docker compose -f docker/docker-compose.yml up -d sync-db sync-gotrue sync-kong sync-server

          # Wait for services to be healthy
          echo "Waiting for backend services..."
          for i in {1..60}; do
            if curl -s http://localhost:3002/ > /dev/null 2>&1; then
              echo "Sync server is ready!"
              break
            fi
            echo "Waiting for sync server... ($i/60)"
            sleep 2
          done

          # Verify all services are up
          docker compose -f docker/docker-compose.yml ps

      - name: Create test script
        run: |
          cat > /tmp/android-e2e-test.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          WORKSPACE="$1"
          echo "Working directory: $(pwd)"
          echo "WORKSPACE: $WORKSPACE"
          ls -la "$WORKSPACE/apk/"
          APK_FILE=$(find "$WORKSPACE/apk" -name "*.apk" -type f 2>/dev/null | head -1)
          echo "Found APK file: $APK_FILE"
          if [ -z "$APK_FILE" ]; then
            echo "ERROR: No APK file found!"
            exit 1
          fi
          adb install "$APK_FILE"
          adb reverse tcp:3002 tcp:3002
          adb reverse tcp:8000 tcp:8000
          echo "Running Maestro smoke test..."
          ~/.maestro/bin/maestro test "$WORKSPACE/.maestro/android-smoke-test.yaml" --format junit --output "$WORKSPACE/maestro-results.xml" || true
          if [ -f "$WORKSPACE/.maestro/android-sync-test.yaml" ]; then
            ~/.maestro/bin/maestro test "$WORKSPACE/.maestro/android-sync-test.yaml" --format junit --output "$WORKSPACE/maestro-sync-results.xml" || true
          fi
          SCRIPT
          chmod +x /tmp/android-e2e-test.sh

      - name: Run Android E2E Tests
        id: test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          working-directory: ${{ github.workspace }}
          script: /tmp/android-e2e-test.sh ${{ github.workspace }}

      - name: Upload Maestro test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-e2e-results-${{ inputs.build_type }}-${{ github.run_id }}
          path: |
            maestro-results.xml
            maestro-sync-results.xml
            ~/.maestro/tests/
          retention-days: 30

      - name: Write Android test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Android E2E Test Result" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test.outcome }}" == "success" ]; then
            echo "✅ **Android tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Android tests failed**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Stop backend services
        if: always()
        env:
          HAEX_SYNC_SERVER_PATH: ./repos/haex-sync-server
        run: |
          docker compose -f docker/docker-compose.yml down -v
